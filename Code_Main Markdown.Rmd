---
title: "Final Project Draft"
author: "Dai, Mathew, Tian"
date: '2022-12-10'
output: pdf_document
---

##Project set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE)

#Load the packages
getwd()
library(tidyverse)
library(lubridate)
library(trend)
library(zoo)
library(reshape2)
library(reshape)
library(knitr)

# Set theme
mytheme <- theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right")
theme_set(mytheme)

#Import the emission dataset 
carbon <- read.csv("Data/Raw/Carbon_Monoxide.csv", stringsAsFactors = TRUE)

nitrogen <- read.csv("Data/Raw/Nitrogen_Oxide.csv", stringsAsFactors = TRUE)

#Import the car quantity dataset

Q2018 <- read.csv("Data/Raw/vehicle-fuel-type-count-by-zip-code.csv", stringsAsFactors = TRUE)

Q2020 <- read.csv("Data/Raw/vehicle-count-as-of-1-1-2020.csv", stringsAsFactors = TRUE)

Q2021 <- read.csv("Data/Raw/vehicle-fuel-type-count-by-zip-code-2021.csv", stringsAsFactors = TRUE)
  
Q2022 <- read_csv("Data/Raw/vehicle-fuel-type-count-by-zip-code-2022 (1).csv")
```

#Rationale and Research Questions

#Rationale for the study  
This study examines the number and types of on road motor vehicles that are most responsible for California's carbon monoxide and nitrogen oxide emissions over the course of 5 years (2018–2022).  
Despite an increase in population and automobile use, aggressive air pollution control measures in California have resulted in ongoing improvements in air quality. The state still lags the rest of the country, even though the situation has been gradually getting better. The state of California continues to experience worsening smog due to its population growth, reliance on automobile travel, and warm climate. The Advanced Clean Cars II rule, which was approved by the California Air Resources Board in August 2022, will put California on a path to rapidly expanding the market for zero-emission cars, pickup trucks, and SUVs by 2035 while also bringing about cleaner air and significant reductions in pollution that contributes to global warming[1]. The 2022 scoping plan, a five-year climate change strategy, details California's intention to reduce its dependency on oil while also cleaning up the worst air pollution in the country[2]. The plan also establishes a more aggressive target of reducing carbon emissions by 48% below 1990 levels by 2030, as opposed to the 40% reduction by 2030 mandated by state law. To reach the new 48% objective in just eight years, California, however, still has a long way to go. The reduction in emissions from 1990 levels by 2020 was just about 14% [3]. Furthermore, California is second among US states in terms of overall yearly CO2 emissions of 358.6 million metric tons (Texas ranked first at 706.5 million metric ton emissions)[4]. 
Given the strict legislation to control emissions and the present gap between released and planned emissions, California state is a good case study to understand the patterns of emissions and the types of vehicles responsible for maximum contribution.  

#Rationale for your choice of dataset 
Data from the California Department of Motor Vehicles and the California Air Resources Board are used in this research. As the research studies the trends of the number of vehicles in the state which likely impacts emissions, the motor vehicle data set is useful as it provides total vehicle counts for registered cars with precise as of dates, broken down by ZIP code, model year, fuel type, make, and duty (light/heavy).  The study also examines how the total number of different types of vehicles impacts the state’s emissions. The emission data is useful to examine the relationship between the type and quantity of vehicles on state's emissions as it provides annual averages of carbon monoxide and nitrogen oxide emitted by different subcategories of on-road motor vehicles.

# Dataset Information
This project uses data from two sources: California Air Resources Board (CARB) and California Department of Motor Vehicles (CADMV). Both datasets were retrieved on November 23, 2022. 

For the emissions data, the project group uses California Air Resources Board’s Standard Emission Tool to gather statewide annual average emissions from mobile sources from 2018 to 2022. Since the most emissions from mobile sources are carbon monoxide and nitrogen oxides, this project focuses on the emissions data of these two pollutants. Therefore, there are two data files, one for carbon monoxide and the other for nitrogen oxides. Both datasets contain emissions from 2018 to 2022 under two main mobile categories: on-road motor vehicles and other mobile sources. Under on-road motor vehicles, there are 21 subcategories. From the websites’ variable descriptions, all subcategories with “heavy duty” in their names are considered heavy duty motor vehicles, others are considered as light duty vehicles. Also, all categories listed “diesel” are diesel-fueled, others are gas-fueled. 

Correspondingly, this project uses vehicle number by fuel type data from California Department of Motor Vehicles from 2018 to 2022, to compare with emissions data for the analyses. This includes four reports that provide vehicle counts broken down by Zip code, model year, fuel type, make, and duty of registered vehicles. As the 2018 report was collected on October 1, 2018, while all other reports were collected on January 1 of 2020, 2021, and 2022, and there was no report in 2019, this project uses the 2018 report for both 2018 and 2019 vehicle count data. In each report, it provides vehicle counts in the last column for different groups of year, fuel, make, and duty registered in different locations. 

Limitations: Since the emissions data is annual average, there are few observations for us to analyze. Due to the unmatched categories of quantity and emission data, we are not able to conduct a more detailed analysis. Also, the regression result is restricted to the limited availability of the data. With a larger and more detailed dataset, the result of the regression could be more robust.  

Data Wrangling
The project group processed raw datasets from both sources for analysis purposes. 

For the vehicle counts by fuel type data from California Department of Motor Vehicles, we wrangled the datasets to show the number of vehicles registered in California with different fuel types. Using the unique function, we found that there are 9 types of fuels: gasoline, diesel and diesel hybrid, natural gas, hybrid gasoline, flex-fuel, battery electric, other, plug-in hybrid, and hydrogen fuel cell. Thus, we summed the number of vehicles in the vehicle column conditioned to each fuel type in all four data sets and created a new dataframe “VehicleNumber.Fuel” containing information about number of vehicles registered using different fuels in year 2018 to 2022. We converted characters in this dataframe into numeric for later analyses use. Then we saved this processed data set into the processed folder. 

From the vehicle counts raw datasets, there is one column named “Duty” which differentiates vehicles with either “light” or “heavy”. As this project will be analyzing the effects of heavy and light (gasoline and diesel) vehicles on carbon monoxide and nitrogen oxides emissions, we summed the number of vehicles in rows with two conditions: duty and fuel. We created new dataframes: GasolineVehicle.Duty and DieselVehicle.Duty. In the GasolineVehicle.Duty dataset, we sum the number of vehicles with heavy in Duty and gasoline in the fuel column, and light in Duty and gasoline in Fuel, in years 2018 to 2022. In the DieselVehicle.Duty dataset, we sum the number of vehicles with heavy in Duty and diesel and diesel hybrid in Fuel, and light in Duty and diesel and diesel hybrid in Fuel. We did similar steps to create new datasets for heavy and light vehicle numbers using hybrid gasoline, natural gas, and flex-fuel. Finally, we used rbind and mutate to combine all the previous datasets into a new dataset “Master_table_vehicles”, with year, number of heavy vehicles, number of light vehicles, fuel type, total number of vehicles, share of light vehicles in total vehicles, and share of heavy vehicles in total vehicles. Notably, we added the two percentage columns at the end to represent the share of light/heavy vehicles among all. Then, we saved this dataframe in the processed data. 

The project group then wrangled the two emissions datasets. As this project is focused on motor vehicles, we only need emissions data from on-road motor vehicles. Thus, we select only on-road motor vehicles data from both datasets. We found that it would be easier for regression purposes to have categories as column names and years as row names, so we reformatted the datasets to change the rows and columns. Then, we saved the two new dataframes as “COT” and “NOX” in the processed folder. 

We also created some more dataframes from those two datasets. We pulled out columns with diesel vehicles to form COT.diesel and NOX.diesel. Similarly, we pulled out columns with gasoline fueled vehicles to form COT.gas and NOX.gas. We also pulled out columns with light duty vehicles to form COT.light and NOX.light. We selected columns with heavy duty vehicles to form COT.heavy and NOX.heavy. Then, we changed all the characters to numeric form for calculation use. 

Dataset Description Table
```{r, echo=FALSE}

Data_Summary = data.frame(
  #Column 1
  Description_Name = c("# of Variables", "Variable Tested", "Unit", "Time Range", "Observation", "Raw/Processed", "Class", "Source"), 
  
  #Column 2
  `Vehicle Fuel Type Count 2018` = c("7", "Vehicles", "Vehicle", "2018", "586233", "Raw", "Factor", "CADMV"),
  
  #Column 3
  `Vehicle Fuel Type Count 2020` = c("7", "Vehicles", "Vehicle", "2020", "602394", "Raw", "Factor", "CADMV"), 
  
  #Column 4
  `Vehicle Fuel Type Count 2021` = c("7", "Vehicles", "Vehicle", "2021", "677969", "Raw", "Factor", "CADMV"), 
  
  #Column 5
  `Vehicle Fuel Type Count 2022` = c("7", "Vehicles", "Vehicle", "2022", "722465", "Raw", "Factor", "CADMV"), 
  
  #Column 6
  `COT Emissions Projections` = c("13", "COT Emissions", "Tons per Day", "2018 to 2022", "32", "Raw", "Character", "CARB"), 
  
  #Column 7
  `NOX Emissions Projections` = c("13", "NOX Emissions", "Tons per Day", "2018 to 2022", "32", "Raw", "Character", "CARB"),
  
  #Column 8
  `VehicleNumber.Fuel Dataset` = c("10", "Vehicles", "Vehicle", "2018 to 2022", "5", "Processed", "Numeric", "N/A"), 
  
  #Column 9
  `COT Dataset`= c("22", "COT Emissions", "Tons per Day", "2018 to 2022", "5", "Processed", "Numeric", "N/A"), 
  
  #Column 10
  `NOX Dataset`= c("22", "NOX Emissions", "Tons per Day", "2018 to 2022", "5", "Processed", "Numeric", "N/A")
)

kable(Data_Summary)
```


## Clean up the dataset

```{r, echo=FALSE}
#Find and combine vehicle numbers from different year data set and categorize with different fuel

Q2018$Vehicles <- as.numeric(Q2018$Vehicles)
unique(Q2018$Fuel)
sum(Q2018[which(Q2018$Fuel =="Gasoline"), 7])
sum(Q2018[which(Q2018$Fuel =="Diesel and Diesel Hybrid"), 7])
sum(Q2018[which(Q2018$Fuel =="Natural Gas"), 7])
sum(Q2018[which(Q2018$Fuel =="Hybrid Gasoline"), 7])
sum(Q2018[which(Q2018$Fuel =="Flex-Fuel"), 7])
sum(Q2018[which(Q2018$Fuel =="Battery Electric"), 7])
sum(Q2018[which(Q2018$Fuel =="Other"), 7])
sum(Q2018[which(Q2018$Fuel =="Plug-in Hybrid"), 7])
sum(Q2018[which(Q2018$Fuel =="Hydrogen Fuel Cell"), 7])

Q2020$Vehicles <- as.numeric(Q2020$Vehicles)
sum(Q2020[which(Q2020$Fuel =="Gasoline"), 7])
sum(Q2020[which(Q2020$Fuel =="Diesel and Diesel Hybrid"), 7])
sum(Q2020[which(Q2020$Fuel =="Natural Gas"), 7])
sum(Q2020[which(Q2020$Fuel =="Hybrid Gasoline"), 7])
sum(Q2020[which(Q2020$Fuel =="Flex-Fuel"), 7])
sum(Q2020[which(Q2020$Fuel =="Battery Electric"), 7])
sum(Q2020[which(Q2020$Fuel =="Other"), 7])
sum(Q2020[which(Q2020$Fuel =="Plug-in Hybrid"), 7])
sum(Q2020[which(Q2020$Fuel =="Hydrogen Fuel Cell"), 7])

Q2021$Vehicles <- as.numeric(Q2021$Vehicles)
sum(Q2021[which(Q2021$Fuel =="Gasoline"), 7])
sum(Q2021[which(Q2021$Fuel =="Diesel and Diesel Hybrid"), 7])
sum(Q2021[which(Q2021$Fuel =="Natural Gas"), 7])
sum(Q2021[which(Q2021$Fuel =="Hybrid Gasoline"), 7])
sum(Q2021[which(Q2021$Fuel =="Flex-Fuel"), 7])
sum(Q2021[which(Q2021$Fuel =="Battery Electric"), 7])
sum(Q2021[which(Q2021$Fuel =="Other"), 7])
sum(Q2021[which(Q2021$Fuel =="Plug-in Hybrid"), 7])
sum(Q2021[which(Q2021$Fuel =="Hydrogen Fuel Cell"), 7])

Q2022$Vehicles <- as.numeric(Q2022$Vehicles)
sum(Q2022[which(Q2022$Fuel =="Gasoline"), 7])
sum(Q2022[which(Q2022$Fuel =="Diesel and Diesel Hybrid"), 7])
sum(Q2022[which(Q2022$Fuel =="Natural Gas"), 7])
sum(Q2022[which(Q2022$Fuel =="Hybrid Gasoline"), 7])
sum(Q2022[which(Q2022$Fuel =="Flex-Fuel"), 7])
sum(Q2022[which(Q2022$Fuel =="Battery Electric"), 7])
sum(Q2022[which(Q2022$Fuel =="Other"), 7])
sum(Q2022[which(Q2022$Fuel =="Plug-in Hybrid"), 7])
sum(Q2022[which(Q2022$Fuel =="Hydrogen Fuel Cell"), 7])

#Used Q2018 data for both Y2018 and Y2019 since it was collected in October and others were collected in January
VehicleNumber.Fuel <- data.frame(Year = c("2018", "2019", "2020", "2021", "2022"),
                                 Gasoline = c("26978798", "26978798", "26985319", "25253808","26313272"),
                                 Diesel_Diesel_Hybrid = c("1282387", "1282387", "1271338", "1199349", "1306851"),
                                 Natural_Gas = c("34982", "34982", "29096", "10881", "31403"),
                                 Hybrid_Gasoline = c("1079558", "1079558", "1123090", "1181387", "1299331"),
                                 Flex_Fuel = c("1318691", "1318691", "1257292", "1259789", "1246662"),
                                 Battery_Electric = c("226614", "226614", "306803", "374865", "526266"),
                                 Other = c("7824", "7824", "5867", "47847", "3801"),
                                 Plug_in_Hybrid = c("204002", "204002", "248388", "264112", "305526"),
                                 Hydrogen_Fuel_Cell = c("5138", "5138", "6648", "7481", "10129"))

VehicleNumber.Fuel$Year <- as.numeric(VehicleNumber.Fuel$Year)
VehicleNumber.Fuel$Gasoline <- as.numeric(VehicleNumber.Fuel$Gasoline)
VehicleNumber.Fuel$Diesel_Diesel_Hybrid <- as.numeric(VehicleNumber.Fuel$Diesel_Diesel_Hybrid)
VehicleNumber.Fuel$Natural_Gas <- as.numeric(VehicleNumber.Fuel$Natural_Gas)
VehicleNumber.Fuel$Hybrid_Gasoline <- as.numeric(VehicleNumber.Fuel$Hybrid_Gasoline)
VehicleNumber.Fuel$Flex_Fuel <- as.numeric(VehicleNumber.Fuel$Flex_Fuel)
VehicleNumber.Fuel$Battery_Electric <- as.numeric(VehicleNumber.Fuel$Battery_Electric)
VehicleNumber.Fuel$Other <- as.numeric(VehicleNumber.Fuel$Other)
VehicleNumber.Fuel$Plug_in_Hybrid <- as.numeric(VehicleNumber.Fuel$Plug_in_Hybrid)
VehicleNumber.Fuel$Hydrogen_Fuel_Cell <- as.numeric(VehicleNumber.Fuel$Hydrogen_Fuel_Cell)

write.csv(VehicleNumber.Fuel, row.names = FALSE, file = "Data/Processed/VehicleNumber.Fuel.csv")

#Heavy or light duty in each fuel
#Gasoline
Q2018.gasoline <- 
  Q2018 %>%
  filter(Fuel == "Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2018.gasoline[which(Q2018.gasoline$Duty =="Light"), 3])
sum(Q2018.gasoline[which(Q2018.gasoline$Duty =="Heavy"), 3])

Q2020.gasoline <- 
  Q2020 %>%
  filter(Fuel == "Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2020.gasoline[which(Q2020.gasoline$Duty =="Light"), 3])
sum(Q2020.gasoline[which(Q2020.gasoline$Duty =="Heavy"), 3])

Q2021.gasoline <- 
  Q2021 %>%
  filter(Fuel == "Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2021.gasoline[which(Q2021.gasoline$Duty =="Light"), 3])
sum(Q2021.gasoline[which(Q2021.gasoline$Duty =="Heavy"), 3])

Q2022.gasoline <- 
  Q2022 %>%
  filter(Fuel == "Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2022.gasoline[which(Q2022.gasoline$Duty =="Light"), 3])
sum(Q2022.gasoline[which(Q2022.gasoline$Duty =="Heavy"), 3])

GasolineVehicle.Duty <- data.frame(Year = c("2018", "2019", "2020", "2021", "2022"),
                                   Heavy = c("292958", "292958", "295136", "261439", "265796"),
                                   Light = c("26685840", "26685840", "26690183", "23661814", "24741892"))

write.csv(GasolineVehicle.Duty, row.names = FALSE, file = "Data/Processed/GasolineVehicle.Duty.csv")

#Diesel and Diesel Hybrid
Q2018.diesel <- 
  Q2018 %>%
  filter(Fuel == "Diesel and Diesel Hybrid") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2018.diesel[which(Q2018.diesel$Duty =="Light"), 3])
sum(Q2018.diesel[which(Q2018.diesel$Duty =="Heavy"), 3])

Q2020.diesel <- 
  Q2020 %>%
  filter(Fuel == "Diesel and Diesel Hybrid") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2020.diesel[which(Q2020.diesel$Duty =="Light"), 3])
sum(Q2020.diesel[which(Q2020.diesel$Duty =="Heavy"), 3])

Q2021.diesel <- 
  Q2021 %>%
  filter(Fuel == "Diesel and Diesel Hybrid") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2021.diesel[which(Q2021.diesel$Duty =="Light"), 3])
sum(Q2021.diesel[which(Q2021.diesel$Duty =="Heavy"), 3])

Q2022.diesel <- 
  Q2022 %>%
  filter(Fuel == "Diesel and Diesel Hybrid") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2022.diesel[which(Q2022.diesel$Duty =="Light"), 3])
sum(Q2022.diesel[which(Q2022.diesel$Duty =="Heavy"), 3])

DieselVehicle.Duty <- data.frame(Year = c("2018", "2019", "2020", "2021", "2022"),
                                   Heavy = c("704568", "704568", "694293", "616207", "702098"),
                                   Light = c("577819", "577819", "577045", "541294", "554805"))

write.csv(DieselVehicle.Duty, row.names = FALSE, file = "Data/Processed/DieselVehicle.Duty.csv")

#Natural Gas
Q2018.naturalgas <- 
  Q2018 %>%
  filter(Fuel == "Natural Gas") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2018.naturalgas[which(Q2018.naturalgas$Duty =="Light"), 3])
sum(Q2018.naturalgas[which(Q2018.naturalgas$Duty =="Heavy"), 3])

Q2020.naturalgas <- 
  Q2020 %>%
  filter(Fuel == "Natural Gas") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2020.naturalgas[which(Q2020.naturalgas$Duty =="Light"), 3])
sum(Q2020.naturalgas[which(Q2020.naturalgas$Duty =="Heavy"), 3])

Q2021.naturalgas <- 
  Q2021 %>%
  filter(Fuel == "Natural Gas") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2021.naturalgas[which(Q2021.naturalgas$Duty =="Light"), 3])
sum(Q2021.naturalgas[which(Q2021.naturalgas$Duty =="Heavy"), 3])

Q2022.naturalgas <- 
  Q2022 %>%
  filter(Fuel == "Natural Gas") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2022.naturalgas[which(Q2022.naturalgas$Duty =="Light"), 3])
sum(Q2022.naturalgas[which(Q2022.naturalgas$Duty =="Heavy"), 3])

NaturalGasVehicle.Duty <- data.frame(Year = c("2018", "2019", "2020", "2021", "2022"),
                                   Heavy = c("20455", "20455", "17211", "7558", "22265"),
                                   Light = c("14527", "14527", "11885", "2042", "7738"))


#Hybrid Gasoline
Q2018.hybridgas <- 
  Q2018 %>%
  filter(Fuel == "Hybrid Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2018.hybridgas[which(Q2018.hybridgas$Duty =="Light"), 3])
sum(Q2018.hybridgas[which(Q2018.hybridgas$Duty =="Heavy"), 3])

Q2020.hybridgas <- 
  Q2020 %>%
  filter(Fuel == "Hybrid Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2020.hybridgas[which(Q2020.hybridgas$Duty =="Light"), 3])
sum(Q2020.hybridgas[which(Q2020.hybridgas$Duty =="Heavy"), 3])

Q2021.hybridgas <- 
  Q2021 %>%
  filter(Fuel == "Hybrid Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2021.hybridgas[which(Q2021.hybridgas$Duty =="Light"), 3])
sum(Q2021.hybridgas[which(Q2021.hybridgas$Duty =="Heavy"), 3])

Q2022.hybridgas <- 
  Q2022 %>%
  filter(Fuel == "Hybrid Gasoline") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2022.hybridgas[which(Q2022.hybridgas$Duty =="Light"), 3])
sum(Q2022.hybridgas[which(Q2022.hybridgas$Duty =="Heavy"), 3])

HybridGasVehicle.Duty <- data.frame(Year = c("2018", "2019", "2020", "2021", "2022"),
                                   Heavy = c("0", "0", "0", "122", "117"),
                                   Light = c("1079558", "1079558", "1123090", "1180332", "1282219"))

#Flex-Fuel
Q2018.flexfuel <- 
  Q2018 %>%
  filter(Fuel == "Flex-Fuel") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2018.flexfuel[which(Q2018.flexfuel$Duty =="Light"), 3])
sum(Q2018.flexfuel[which(Q2018.flexfuel$Duty =="Heavy"), 3])

Q2020.flexfuel <- 
  Q2020 %>%
  filter(Fuel == "Flex-Fuel") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2020.flexfuel[which(Q2020.flexfuel$Duty =="Light"), 3])
sum(Q2020.flexfuel[which(Q2020.flexfuel$Duty =="Heavy"), 3])

Q2021.flexfuel <- 
  Q2021 %>%
  filter(Fuel == "Flex-Fuel") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2021.flexfuel[which(Q2021.flexfuel$Duty =="Light"), 3])
sum(Q2021.flexfuel[which(Q2021.flexfuel$Duty =="Heavy"), 3])

Q2022.flexfuel <- 
  Q2022 %>%
  filter(Fuel == "Flex-Fuel") %>%
  select(Fuel, Duty, Vehicles)
sum(Q2022.flexfuel[which(Q2022.flexfuel$Duty =="Light"), 3])
sum(Q2022.flexfuel[which(Q2022.flexfuel$Duty =="Heavy"), 3])

FlexFuelVehicle.Duty <- data.frame(Year = c("2018", "2019", "2020", "2021", "2022"),
                                   Heavy = c("28625", "28625", "30495", "35234", "36645"),
                                   Light = c("1290066", "1290066", "1226797", "1010212", "995624"))

#Creating Master Table for Vehicle data
GasolineVehicle.Duty_a <- GasolineVehicle.Duty %>%
  mutate(Fuel_Type = rep("Gasoline",5)) %>%
  mutate(Heavy = as.numeric(Heavy)) %>%
  mutate(Light = as.numeric(Light))

DieselVehicle.Duty_a <- DieselVehicle.Duty %>%
  mutate(Fuel_Type = rep("Diesel",5)) %>%
 mutate(Heavy = as.numeric(Heavy)) %>%
  mutate(Light = as.numeric(Light))

HybridGasVehicle.Duty_a <- HybridGasVehicle.Duty %>%
  mutate(Fuel_Type = rep("Hybrid Gas",5)) %>%
 mutate(Heavy = as.numeric(Heavy)) %>%
  mutate(Light = as.numeric(Light))

NaturalGasVehicle.Duty_a <- NaturalGasVehicle.Duty %>%
  mutate(Fuel_Type = rep("Natural Gas",5)) %>%
 mutate(Heavy = as.numeric(Heavy)) %>%
  mutate(Light = as.numeric(Light))

FlexFuelVehicle.Duty_a <- FlexFuelVehicle.Duty %>%
  mutate(Fuel_Type = rep("Flex Fuel",5)) %>%
 mutate(Heavy = as.numeric(Heavy)) %>%
  mutate(Light = as.numeric(Light))

Master_table_vehicles <- rbind(GasolineVehicle.Duty_a,DieselVehicle.Duty_a,HybridGasVehicle.Duty_a,NaturalGasVehicle.Duty_a,FlexFuelVehicle.Duty_a) %>%
  mutate(Total_vehicle = as.numeric(Light) + as.numeric(Heavy) ) %>%
  mutate(Share_Light = Light/Total_vehicle) %>%
  mutate(Share_Heavy = Heavy/Total_vehicle)

write.csv(Master_table_vehicles, row.names = FALSE, file = "Data/Processed/Master_table_vehicles.csv")

#Emission Data cleaning: select only on-road vehicles
Carbon.Monoxide <- carbon [carbon$CATEGORY == "ON-ROAD MOTOR VEHICLES", ]

Carbon.Monoxide <-
  Carbon.Monoxide %>%
  select(SUBCATEGORY, X2018, X2019, X2020, X2021, X2022)

COT <-
  Carbon.Monoxide %>%
  rownames_to_column() %>%
  gather(variable, value, -rowname) %>% 
  spread(rowname, value)


COT <- COT[, c(1, 2, 13, 16, 17, 18, 19, 20, 21, 22, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 14, 15)]
colnames(COT) <- COT[1,]
COT <- COT[-1, ]
colnames(COT)[1] <- "Year"

write.csv(COT, row.names = FALSE, file = "Data/Processed/COT.csv")

Nitrogen.Oxide <- nitrogen [nitrogen$CATEGORY == "ON-ROAD MOTOR VEHICLES", ]

Nitrogen.Oxide <-
  Nitrogen.Oxide %>%
  select(SUBCATEGORY, X2018, X2019, X2020, X2021, X2022)

NOX <-
  Nitrogen.Oxide %>%
  rownames_to_column() %>%
  gather(variable, value, -rowname) %>% 
  spread(rowname, value)
NOX <- NOX[, c(1, 2, 13, 16, 17, 18, 19, 20, 21, 22, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 14, 15)]
colnames(NOX) <- NOX[1,]
NOX <- NOX[-1, ]
colnames(NOX)[1] <- "Year"

write.csv(NOX, row.names = FALSE, file = "Data/Processed/NOX.csv")

#Separate emission by factor "gas" and "diesel"
COT.gas <- 
  COT %>%
  select(c(1:9, 14, 16, 17, 19, 22))
COT.diesel <-
  COT %>%
  select(c(1, 10:13, 15, 18, 20, 21))

NOX.gas <- 
  NOX %>%
  select(c(1:9, 14, 16, 17, 19, 22))
NOX.diesel <-
  NOX %>%
  select(c(1, 10:13, 15, 18, 20, 21))

#Change character to numeric
COT.gas$`LIGHT DUTY PASSENGER (LDA)` <- as.numeric(COT.gas$`LIGHT DUTY PASSENGER (LDA)`)
COT.gas$`LIGHT DUTY TRUCKS - 1 (LDT1)` <- as.numeric (COT.gas$`LIGHT DUTY TRUCKS - 1 (LDT1)`)
COT.gas$`LIGHT DUTY TRUCKS - 2 (LDT2)` <- as.numeric (COT.gas$`LIGHT DUTY TRUCKS - 2 (LDT2)`)
COT.gas$`MEDIUM DUTY TRUCKS (MDV)`<- as.numeric (COT.gas$`MEDIUM DUTY TRUCKS (MDV)`)
COT.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)` <- as.numeric(COT.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)`)
COT.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)` <- as.numeric(COT.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)`)
COT.gas$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)` <- as.numeric(COT.gas$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)`)
COT.gas$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)` <- as.numeric(COT.gas$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)`)
COT.gas$`MOTORCYCLES (MCY)` <-as.numeric(COT.gas$`MOTORCYCLES (MCY)`)
COT.gas$`HEAVY DUTY GAS URBAN BUSES (UBG)` <- as.numeric(COT.gas$`HEAVY DUTY GAS URBAN BUSES (UBG)`)
COT.gas$`SCHOOL BUSES - GAS (SBG)`<-as.numeric(COT.gas$`SCHOOL BUSES - GAS (SBG)`)
COT.gas$`OTHER BUSES - GAS (OBG)` <-as.numeric(COT.gas$`OTHER BUSES - GAS (OBG)`)
COT.gas$`MOTOR HOMES (MH)`<-as.numeric(COT.gas$`MOTOR HOMES (MH)`)

COT.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)` <- as.numeric(COT.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)`)
COT.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)` <- as.numeric(COT.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)`)
COT.diesel$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)` <- as.numeric(COT.diesel$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)`)
COT.diesel$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)` <- as.numeric(COT.diesel$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)`)
COT.diesel$`HEAVY DUTY DIESEL URBAN BUSES (UBD)` <- as.numeric(COT.diesel$`HEAVY DUTY DIESEL URBAN BUSES (UBD)`)
COT.diesel$`SCHOOL BUSES - DIESEL (SBD)` <- as.numeric(COT.diesel$`SCHOOL BUSES - DIESEL (SBD)`)
COT.diesel$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)` <- as.numeric(COT.diesel$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)`)
COT.diesel$`ALL OTHER BUSES - DIESEL (OBD)` <- as.numeric(COT.diesel$`ALL OTHER BUSES - DIESEL (OBD)`)

NOX.gas$`LIGHT DUTY PASSENGER (LDA)` <- as.numeric(NOX.gas$`LIGHT DUTY PASSENGER (LDA)`)
NOX.gas$`LIGHT DUTY TRUCKS - 1 (LDT1)` <- as.numeric (NOX.gas$`LIGHT DUTY TRUCKS - 1 (LDT1)`)
NOX.gas$`LIGHT DUTY TRUCKS - 2 (LDT2)` <- as.numeric (NOX.gas$`LIGHT DUTY TRUCKS - 2 (LDT2)`)
NOX.gas$`MEDIUM DUTY TRUCKS (MDV)`<- as.numeric (NOX.gas$`MEDIUM DUTY TRUCKS (MDV)`)
NOX.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)` <- as.numeric(NOX.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)`)
NOX.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)` <- as.numeric(NOX.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)`)
NOX.gas$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)` <- as.numeric(NOX.gas$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)`)
NOX.gas$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)` <- as.numeric(NOX.gas$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)`)
NOX.gas$`MOTORCYCLES (MCY)` <-as.numeric(NOX.gas$`MOTORCYCLES (MCY)`)
NOX.gas$`HEAVY DUTY GAS URBAN BUSES (UBG)` <- as.numeric(NOX.gas$`HEAVY DUTY GAS URBAN BUSES (UBG)`)
NOX.gas$`SCHOOL BUSES - GAS (SBG)`<-as.numeric(NOX.gas$`SCHOOL BUSES - GAS (SBG)`)
NOX.gas$`OTHER BUSES - GAS (OBG)` <-as.numeric(NOX.gas$`OTHER BUSES - GAS (OBG)`)
NOX.gas$`MOTOR HOMES (MH)`<-as.numeric(NOX.gas$`MOTOR HOMES (MH)`)

NOX.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)` <- as.numeric(NOX.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)`)
NOX.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)` <- as.numeric(NOX.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)`)
NOX.diesel$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)` <- as.numeric(NOX.diesel$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)`)
NOX.diesel$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)` <- as.numeric(NOX.diesel$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)`)
NOX.diesel$`HEAVY DUTY DIESEL URBAN BUSES (UBD)` <- as.numeric(NOX.diesel$`HEAVY DUTY DIESEL URBAN BUSES (UBD)`)
NOX.diesel$`SCHOOL BUSES - DIESEL (SBD)` <- as.numeric(NOX.diesel$`SCHOOL BUSES - DIESEL (SBD)`)
NOX.diesel$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)` <- as.numeric(NOX.diesel$`ALL OTHER BUSES - DIESEL (OBD)`)
NOX.diesel$`ALL OTHER BUSES - DIESEL (OBD)` <- as.numeric(NOX.diesel$`ALL OTHER BUSES - DIESEL (OBD)`)

#Separate emission by factor "light duty" and "heavy duty"
#Any category containing "heavy duty" in their names is considered heavy, others(including buses) are light
COT.light <-
  COT %>%
  select (c(1:5, 14, 17:22))
COT.heavy <-
  COT %>%
  select(c(1, 6:13, 15, 16))

NOX.light <-
  NOX %>%
  select (c(1:5, 14, 17:22))
NOX.heavy <-
  NOX %>%
  select(c(1, 6:13, 15, 16))


#Change the Year column in COT and NOX datasets for plot use
COT.diesel$Year <- c(2018,2019,2020,2021,2022)
COT.gas$Year <- c(2018,2019,2020,2021,2022)
COT.heavy$Year <- c(2018,2019,2020,2021,2022)
COT.light$Year <- c(2018,2019,2020,2021,2022)
NOX.diesel$Year <- c(2018,2019,2020,2021,2022)
NOX.gas$Year <- c(2018,2019,2020,2021,2022)
NOX.heavy$Year <- c(2018,2019,2020,2021,2022)
NOX.light$Year <- c(2018,2019,2020,2021,2022)

#Change COT character to numeric for regression use
COT$Year <- c("2018", "2019", "2020", "2021", "2022")
COT$Year <- as.Date(COT$Year, format = "%Y")
COT$Year <- year(COT$Year)
COT$`LIGHT DUTY PASSENGER (LDA)` <- as.numeric(COT$`LIGHT DUTY PASSENGER (LDA)`)
COT$`LIGHT DUTY TRUCKS - 1 (LDT1)` <- as.numeric(COT$`LIGHT DUTY TRUCKS - 1 (LDT1)`)
COT$`LIGHT DUTY TRUCKS - 2 (LDT2)` <- as.numeric(COT$`LIGHT DUTY TRUCKS - 2 (LDT2)`)
COT$`MEDIUM DUTY TRUCKS (MDV)` <- as.numeric(COT$`MEDIUM DUTY TRUCKS (MDV)`)
COT$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)` <- as.numeric(COT$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)`)
COT$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)` <- as.numeric(COT$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)`)
COT$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)` <- as.numeric(COT$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)`)
COT$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)` <- as.numeric(COT$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)`)
COT$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)` <- as.numeric(COT$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)`)
COT$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)` <- as.numeric(COT$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)`)
COT$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)` <- as.numeric(COT$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)`)
COT$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)` <- as.numeric(COT$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)`)
COT$`MOTORCYCLES (MCY)` <- as.numeric(COT$`MOTORCYCLES (MCY)`)
COT$`HEAVY DUTY DIESEL URBAN BUSES (UBD)` <- as.numeric(COT$`HEAVY DUTY DIESEL URBAN BUSES (UBD)`)
COT$`HEAVY DUTY GAS URBAN BUSES (UBG)` <- as.numeric(COT$`HEAVY DUTY GAS URBAN BUSES (UBG)`)
COT$`SCHOOL BUSES - GAS (SBG)` <- as.numeric(COT$`SCHOOL BUSES - GAS (SBG)`)
COT$`SCHOOL BUSES - DIESEL (SBD)` <- as.numeric(COT$`SCHOOL BUSES - DIESEL (SBD)`)
COT$`OTHER BUSES - GAS (OBG)` <- as.numeric(COT$`OTHER BUSES - GAS (OBG)`)
COT$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)` <- as.numeric(COT$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)`)
COT$`ALL OTHER BUSES - DIESEL (OBD)` <- as.numeric(COT$`ALL OTHER BUSES - DIESEL (OBD)`)
COT$`MOTOR HOMES (MH)` <- as.numeric(COT$`MOTOR HOMES (MH)`)

```

##Exploratory Analysis 

*Questions for Exploratory Analysis* 

Question 1: How has the number of different types of vehicle has changed over time? 
Sub question a: How has the number of heavy-duty and light-duty vehicle changed over time
 
##Exploratory Analysis 
This section analyses the trend of the number of vehicles over time by type of vehicle in the state and emission of nitrogen oxide and carbon monoxide by diesel-run, gas-run, light-duty, and heavy-duty vehicles. It is divided into two parts: analysis of vehicle data and emission data. 

*Trends of number of vehicles in the state over time* 

Figures 1 and 2 below show the change in the number of different types of vehicles over time. The graph shows that the number of gasoline cars is the highest in the state. However, the number steeply declined in 2021 and rose in 2022. This is potentially due to COVID-19's impact. The flex-fuel, diesel hybrid and gasoline hybrid vehicles are also relatively much higher than the rest of the types of vehicles.  Diesel hybrid and Gasoline hybrid have shown a rising trend since 2019 and 2021 respectively. Whereas flex-fuel has been declining for the past two years. Electric vehicles have shown a steep rise since 2019.   

Note: Due to the quantity of gasoline cars is too large, we separate it as an independent graph to present the quantity changes 

```{r, echo=FALSE}
#############Trend Analysis#############
###PART 1
#Number changes over the years
ds1 <- melt(VehicleNumber.Fuel,id="Year")
ds1$value <- as.numeric(ds1$value)
ds1_sub <- subset (ds1, variable != "Gasoline")
ds1_sub2 <- subset (ds1, variable == "Gasoline")

#plot #of cars changes over the years (Without gasoline)
ggplot(ds1_sub, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Quantity")+
  theme(legend.position = "bottom")+
  labs(color="Type of vehicles", title = paste("Change in the variety of vehicles across time"), subtitle = "Figure 1")

#plot #of cars changes over the years (Only gasoline)
#ps. Due to the quantity of gasoline cars is too large, we seperate it as an independent graph to present the quantity changes
ggplot(ds1_sub2, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Quantity")+
  theme(legend.position = "right")+
  labs(color="Type of vehicles", title = paste("Change in the gasoline vehicles across time"), subtitle = "Figure 2")

```

*Trends of heavy and light duty cars over time* 

Figure 3 below shows the trend of heavy vehicles by vehicle type across time. The state has a higher share (more than 50 percent) of heavy-duty gasoline and diesel-run vehicles than other types of vehicles. The natural gas heavy-duty vehicle has shown an increase in 2020 and then a slight decline since 2021. The share of other types of heavy-duty vehicles such as gasoline, hybrid gasoline, and flex-fuel vehicles has remained below 5 percent over time. 

Figure 4 below shows the trend of light vehicles by vehicle type across time.  Natural gas light-duty vehicle has shown a decline in 2020 and then a slight increase since 2021. The share of other types of light-duty vehicles such as gasoline, hybrid gasoline, and flex-fuel vehicles has remained higher than 90 percent over time. 

Note: Share is calculated as for example, heavy-duty vehicle diesel/Total diesel vehicles 
  
```{r, echo=FALSE}
#trend of heavy and light duty cars over time

#Heavy vehicle trend over time
ggplot(Master_table_vehicles, aes(x=Year,y=Share_Heavy,group=Fuel_Type,color=Fuel_Type))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Share of Heavy Vehicle")+
  theme(legend.position = "bottom")+
  labs(color="Type of vehicles", title = paste("Change in share of heavy duty vehicles across time"), subtitle = "Figure 3")

#Light vehicle trend over time
ggplot(Master_table_vehicles, aes(x=Year,y=Share_Light,group=Fuel_Type,color=Fuel_Type))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Share of Light Vehicle")+
  theme(legend.position = "bottom")+
  labs(color="Type of vehicles", title = paste("Change in share of light duty vehicles across time"), subtitle = "Figure 4")
```

# Analysis
This section is divided into two types of analysis: Trend Analysis and Regression Analysis

#Questions for trend analysis
Question 1: What are the trends of two types of emission, nitrogen oxide and carbon monoxide, from diesel-run, gas-run, light-duty and heavy-duty vehicles.

# Trend Analysis
#Analysis of emission data 

*Comparison of nitrogen oxide and carbon monoxide emissions of diesel-run vehicles.*  

Figure 5 and 6 below shows the trend of nitrogen oxide and carbon monoxide emissions of diesel-run vehicles over time, respectively. The overall trend of nitrogen oxide emissions has shown a declining trend across all the subcategories. The carbon monoxide emissions trend of diesel-run vehicles remains like nitrogen oxide emission except for y-duty diesel urban buses which has increased over time.  

```{r, echo=FALSE}
###PART2
#nitrogen oxide and carbon monoxide of diesel-run vehicles

#NOX.diesel 
#changing cloumn names for graphic purposes
colnames(NOX.diesel) <- c("Year","LHDDT1","LHDDT2","MHDDT","HHDDT","UBD","SBD","OBC","OBD")

ds2_d <- melt(NOX.diesel,id="Year")
ds2_d$value <- as.numeric(ds2_d$value)

ggplot(ds2_d, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Nitrogen Oxide emission of diesel run vehicles across time"), subtitle = "Figure 5") 

#COT
#COT.diesel
#changing cloumn names for graphic purposes
colnames(COT.diesel) <- c("Year","LHDDT1","LHDDT2","MHDDT","HHDDT","UBD","SBD","OBC","OBD")

ds3_d <- melt(COT.diesel,id="Year")
ds3_d$value <- as.numeric(ds3_d$value)
ggplot(ds3_d, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Carbon Monoxide emission of diesel run vehicles across time"), subtitle = "Figure 6")
```

*Comparison of nitrogen oxide and carbon monoxide emissions of gas-run vehicles.* 

Figure 7 and 8 below shows the trend of nitrogen oxide and carbon monoxide emissions of gas-run vehicles over time, respectively. The trend shows that both types of emissions from gas-run vehicles have decreased or remained stable over time across all the subcategories. 

```{r, echo=FALSE}
#nitrogen oxide and carbon monoxide of gas-run vehicles

#NOX.gas
NOX.gas_graph <- NOX.gas
colnames(NOX.gas_graph) <- c("Year","LDA","LDT1","LDT2","MDV","LHDGTI1","LHDGTI1","MHDGT","HHDGT", "MCY", "UBG","SBG", "OBG", "MH")

ds2_g <- melt(NOX.gas_graph,id="Year")
ds2_g$value <- as.numeric(ds2_g$value)
ggplot(ds2_g, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Nitrogen Oxide emission of gas run vehicles across time"), subtitle = "Figure 7")

#COT.gas
COT.gas_graph <- COT.gas
colnames(COT.gas_graph) <- c("Year","LDA","LDT1","LDT2","MDV","LHDGTI1","LHDGTI1","MHDGT","HHDGT", "MCY", "UBG","SBG", "OBG", "MH")

ds3_g <- melt(COT.gas_graph,id="Year")
ds3_g$value <- as.numeric(ds3_g$value)
ggplot(ds3_g, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Carbon Monoxide emission of gas run vehicles across time"), subtitle = "Figure 8")
```

*Comparison of nitrogen oxide and carbon monoxide emissions of light-duty vehicles.*

Figure 9 and 10 below show the trend of nitrogen oxide and carbon monoxide emissions of light-duty vehicles over time, respectively. The trend shows that both types of emissions from light-duty vehicles have decreased or remained stable over time across all the subcategories. 

```{r, echo=FALSE}
#nitrogen oxide and carbon monoxide of light-duty vehicles

#NOX.light
NOX.light_graph <- NOX.light
colnames(NOX.light_graph) <- c("Year","LDA","LDT1","LDT2","MDV","MCY","SBG","SBD","OBG", "OBC", "OBD","MH")

ds2_l <- melt(NOX.light_graph,id="Year")
ds2_l$value <- as.numeric(ds2_l$value)
ggplot(ds2_l, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Nitrogen Oxide emission of light-duty vehicles across time"), subtitle = "Figure 9")

#COT.light
COT.light_graph <- COT.light
colnames(COT.light_graph) <- c("Year","LDA","LDT1","LDT2","MDV","MCY","SBG","SBD","OBG", "OBC", "OBD","MH")

ds3_l <- melt(COT.light_graph,id="Year")
ds3_l$value <- as.numeric(ds3_l$value)
ggplot(ds3_l, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Carbon Monoxide emission of light duty vehicles across time"), subtitle = "Figure 10")
```

*Comparison of nitrogen oxide and carbon monoxide emissions of heavy-duty vehicles.*

Figure 11 and 12 below show the trend of nitrogen oxide and carbon monoxide emissions of heavy-duty vehicles over time, respectively. The trend shows that the nitrogen oxide emissions from heavy-duty vehicles have decreased or remained stable over time across all the subcategories. The arbon monoxide emissions trend of diesel-run vehicles remains like nitrogen oxide emission except for heavy-duty diesel urban buses which has increased over time.  

```{r, echo=FALSE}
#nitrogen oxide and carbon monoxide of heavy-duty vehicles
#NOX.heavy
NOX.heavy_graph <- NOX.heavy
colnames(NOX.heavy_graph) <- c("Year","LHDGT1","LHDGT2","MHDGT","HHDGT","LHDDT1","LHDDT2","MHDDT","HHDDT", "UBD", "UBG")
ds2_h <- melt(NOX.heavy_graph,id="Year")
ds2_h$value <- as.numeric(ds2_h$value)
ggplot(ds2_h, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles", title = paste("Trend of Nitrogen Oxide emission of heavy-duty vehicles across time"), subtitle = "Figure 11")

#COT.heavy
COT.heavy_graph <- COT.heavy
colnames(COT.heavy_graph) <- c("Year","LHDGT1","LHDGT2","MHDGT","HHDGT","LHDDT1","LHDDT2","MHDDT","HHDDT", "UBD", "UBG")
ds3_h <- melt(COT.heavy_graph,id="Year")
ds3_h$value <- as.numeric(ds3_h$value)
ggplot(ds3_h, aes(x=Year,y=value,group=variable,color=variable))+
  geom_point()+
  geom_line()+
  xlab("Year")+
  ylab("Emission")+
  theme(legend.position = "bottom",legend.key.size = unit(.5, 'cm'))+
  labs(color="Type of vehicles",  title = paste("Trend of Carbon Monoxide emission of heavy duty vehicles across time"), subtitle = "Figure 12")
```

##Regression Analysis 

#Questions for regression analysis

```{r, echo=FALSE}
#############Regression Analysis#############
# car quantity and emission
#COT.diesel
COT.diesel$sum <- COT.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)`+COT.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)`+COT.diesel$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)`+COT.diesel$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)`+COT.diesel$`HEAVY DUTY DIESEL URBAN BUSES (UBD)`+COT.diesel$`SCHOOL BUSES - DIESEL (SBD)`+COT.diesel$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)`+COT.diesel$`ALL OTHER BUSES - DIESEL (OBD)`

#COT.gas
COT.gas$sum <- COT.gas$`LIGHT DUTY PASSENGER (LDA)`+COT.gas$`LIGHT DUTY TRUCKS - 1 (LDT1)` +COT.gas$`LIGHT DUTY TRUCKS - 2 (LDT2)`+COT.gas$`MEDIUM DUTY TRUCKS (MDV)`+COT.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)`+COT.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)` +COT.gas$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)`+COT.gas$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)` +COT.gas$`MOTORCYCLES (MCY)`+COT.gas$`HEAVY DUTY GAS URBAN BUSES (UBG)`+COT.gas$`SCHOOL BUSES - GAS (SBG)`+COT.gas$`OTHER BUSES - GAS (OBG)`+COT.gas$`MOTOR HOMES (MH)`

ds4 <- data.frame(COT.diesel$Year,COT.diesel$sum,VehicleNumber.Fuel$Diesel_Diesel_Hybrid,COT.gas$sum,VehicleNumber.Fuel$Gasoline)
ds4$Quantity.diesel <-ds4$VehicleNumber.Fuel.Diesel_Diesel_Hybrid
ds4$Emission.diesel <-ds4$COT.diesel.sum
ds4$Quantity.gas <-ds4$VehicleNumber.Fuel.Gasoline
ds4$Emission.gas <-ds4$COT.gas.sum

ds4$Quantity.diesel <- as.numeric(ds4$Quantity.diesel)
ds4$Quantity.gas <- as.numeric(ds4$Quantity.gas)

reg1 <- lm(data = ds4, Emission.diesel ~ Quantity.diesel)
summary(reg1)

reg2 <- lm(ds4$Emission.gas ~ ds4$Quantity.gas)
summary(reg2)

#NOX 
#Nox.diesel
NOX.diesel$sum <- NOX.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 1 (LHDDT1)`+NOX.diesel$`LIGHT HEAVY DUTY DIESEL TRUCKS - 2 (LHDDT2)`+NOX.diesel$`MEDIUM HEAVY DUTY DIESEL TRUCKS (MHDDT)`+NOX.diesel$`HEAVY HEAVY DUTY DIESEL TRUCKS (HHDDT)` +NOX.diesel$`HEAVY DUTY DIESEL URBAN BUSES (UBD)`+NOX.diesel$`SCHOOL BUSES - DIESEL (SBD)`+NOX.diesel$`OTHER BUSES - MOTOR COACH - DIESEL (OBC)`

#NOX.gas

NOX.gas$sum <- NOX.gas$`LIGHT DUTY PASSENGER (LDA)`+ NOX.gas$`LIGHT DUTY TRUCKS - 1 (LDT1)`+NOX.gas$`LIGHT DUTY TRUCKS - 2 (LDT2)`+ NOX.gas$`MEDIUM DUTY TRUCKS (MDV)`+NOX.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 1 (LHDGT1)`+NOX.gas$`LIGHT HEAVY DUTY GAS TRUCKS - 2 (LHDGT2)`+ NOX.gas$`MEDIUM HEAVY DUTY GAS TRUCKS (MHDGT)`+ NOX.gas$`HEAVY HEAVY DUTY GAS TRUCKS (HHDGT)`+ NOX.gas$`MOTORCYCLES (MCY)`+NOX.gas$`HEAVY DUTY GAS URBAN BUSES (UBG)`+NOX.gas$`SCHOOL BUSES - GAS (SBG)`+NOX.gas$`OTHER BUSES - GAS (OBG)`+NOX.gas$`MOTOR HOMES (MH)`

ds5 <- data.frame(NOX.diesel$Year,NOX.diesel$sum,VehicleNumber.Fuel$Diesel_Diesel_Hybrid,NOX.gas$sum,VehicleNumber.Fuel$Gasoline)
ds5$Quantity.diesel <-ds5$VehicleNumber.Fuel.Diesel_Diesel_Hybrid
ds5$Emission.diesel <-ds5$NOX.diesel.sum
ds5$Quantity.gas <-ds5$VehicleNumber.Fuel.Gasoline
ds5$Emission.gas <-ds5$NOX.gas.sum

ds5$Quantity.diesel <- as.numeric(ds4$Quantity.diesel)
ds5$Quantity.gas <- as.numeric(ds4$Quantity.gas)

reg3 <- lm(data = ds5, Emission.diesel ~ Quantity.diesel)
summary(reg3)

reg4 <- lm(ds5$Emission.gas ~ ds5$Quantity.gas)
summary(reg4)


#Multivariable regression
#COT
rowSums(COT[ , c(2:22)], na.rm=TRUE)

ds6 <- 
  COT%>%
  mutate(Total_Emission = c(1844.808, 1694.213, 1570.754, 1464.898, 1365.674))

reg6 <- lm(data = ds6, 
           Total_Emission ~  `HEAVY DUTY DIESEL URBAN BUSES (UBD)` + `HEAVY DUTY GAS URBAN BUSES (UBG)` )
summary(reg6)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Summary and Conclusions




#Reference
[1]“California Moves to Accelerate to 100% New Zero-Emission Vehicle Sales by 2035 | California Air Resources Board,” accessed December 13, 2022, https://ww2.arb.ca.gov/news/california-moves-accelerate-100-new-zero-emission-vehicle-sales-2035.

[2] “2022 Scoping Plan Documents | California Air Resources Board,” accessed December 13, 2022, https://ww2.arb.ca.gov/our-work/programs/ab-32-climate-change-scoping-plan/2022-scoping-plan-documents.

[3] “Greenhouse Gases Emitted in California,” accessed December 13, 2022, https://datawrapper.dwcdn.net/PR9hr/7/.

[4] Joe Robertson, “U.S. States Ranked by Carbon Dioxide Emissions per Capita - Solar Power Guide - Infographic,” accessed December 13, 2022, https://solarpower.guide/solar-energy-insights/states-ranked-carbon-dioxide-emissions.